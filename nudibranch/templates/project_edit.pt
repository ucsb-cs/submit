<div metal:use-macro="_LAYOUT">
<div metal:fill-slot="content">

  <script>
    $(function() {
      $(".dialog").dialog({autoOpen: false});
      $("#testable_tab").tabs();
    });
  </script>

  <div class="header">${page_title}</div>
  <form id="project_form" name="input" action="${action}"
        onsubmit="return form_request(this, 'POST', true);">
    <fieldset>
      <legend>Basic Settings</legend>
      <label for="name">Name</label>
      <br/>
      <input type="text" name="name" id="name" value="${project.name}" />
      <br/>
      <div tal:condition="project.makefile">
        <a href="${_R('file_item', sha1sum=project.makefile.sha1)}">Existing Makefile</a></div>
      <label for="makefile">Select a Makefile: </label>
      <input name="makefile_id" id="makefile" type="file" />
      <input type="hidden" name="makefile_id" value="${project.makefile_id}" />
      <br/>
      <input type="submit" name="submit" value="Update" />
    </fieldset>
  </form>

  <h3><span class="help" title="A testable defines the parameters for a single executable that is produced from the student's submission.">Testables</span></h3>
  <div id="testable_tab">
    <ul>
      <li tal:repeat="testable project.testables">
        <a href="#testable_tab_${repeat.testable.index}">${testable.name}</a>
      </li>
      <li><a href="#testable_tab_new">New</a></li>
    </ul>

    <div tal:repeat="testable project.testables" id="testable_tab_${repeat.testable.index}">
      <form name="testable" action="${_R('testable_item', testable_id=testable.id)}"
            onsubmit="return form_request(this, 'POST', true);">
        <label for="testable_name_${repeat.testable.index}">Name</label>
        <input type="text" name="name" id="testable_name_${repeat.testable.index}"
               value="${testable.name}" />
        <br/>
        <label for="make_target_${repeat.testable.index}">Make target</label>
        <input type="text" name="make_target" id="make_target_${repeat.testable.index}"
               value="${testable.make_target}" />
        <br/>
        <label for="executable_${repeat.testable.index}">Executable</label>
        <input type="text" name="executable" id="executable_${repeat.testable.index}"
               value="${testable.executable}" />
        <br/>
        <fieldset>
          <legend>Select <span class="help" title="Expected files are those that students submit with their projects.">Expected Files</span></legend>
          <div tal:repeat="fv sorted(project.file_verifiers)">
            <input type="checkbox" name="file_verifier_ids[]"
                   id="testable_fv_${repeat.testable.index}_${repeat.fv.index}"
                   value="${fv.id}" tal:attributes="checked 'checked' if fv in testable.file_verifiers else None" />
            <label for="testable_fv_${repeat.testable.index}_${repeat.fv.index}">${fv.filename}</label>
            (<span class="faulink" onclick="$('#file_verifier_${repeat.fv.index}').dialog('open');">edit</span>)
          </div>
          <span class="faulink" onclick="$('#file_verifier_new').dialog('open');">define new expected file</span>
        </fieldset>
        <input type="hidden" name="project_id" value="${project.id}" />
        <input type="submit" name="submit" value="update" />
        <br/>
        <br/>

        <fieldset>
          <legend>Test Cases</legend>
          <ul>
            <li tal:repeat="tc sorted(testable.test_cases)">
              <span class="faulink" onclick="$('#testable_${repeat.testable.index}_tc_${repeat.tc.index}').dialog('open');">${tc.name}</span>
            </li>
            <li>(<span class="faulink" onclick="$('#testable_${repeat.testable.index}_tc_new').dialog('open');">add new test case</span>)</li>
          </ul>
        </fieldset>
      </form>
    </div>

    <div id="testable_tab_new" style="background: #ccf">
      <form name="testable" action="${_R('testable')}"
            onsubmit="return form_request(this, 'PUT', true);">
        <label for="testable_name_new">Name</label>
        <input type="text" name="name" id="testable_name_new" />
        <br/>
        <label for="make_target_new">Make target</label>
        <input type="text" name="make_target" id="make_target_new" />
        <br/>
        <label for="executable_new">Executable</label>
        <input type="text" name="executable" id="executable_new" />
        <br/>
        <fieldset>
          <legend>Select <span class="help" title="Expected files are those that students submit with their projects.">Expected Files</span></legend>
          <div tal:repeat="fv sorted(project.file_verifiers)">
            <input type="checkbox" name="file_verifier_ids[]"
                   id="testable_fv_new_${repeat.fv.index}"
                   value="${fv.id}" />
            <label for="testable_fv_new_${repeat.fv.index}">${fv.filename}</label>
            (<span class="faulink" onclick="$('#file_verifier_${repeat.fv.index}').dialog('open');">edit</span>)
          </div>
          <span class="faulink" onclick="$('#file_verifier_new').dialog('open');">define new expected file</span>
        </fieldset>
        <input type="hidden" name="project_id" value="${project.id}" />
        <input type="submit" name="submit" value="add" />
      </form>
      </div>
  </div>

  <!-- Dialog Boxes -->
  <div id="file_verifier_new" class="dialog" title="Add New Expected File" style="background: #ccf">
    <form name="file_verifier" action="${_R('file_verifier')}"
          onsubmit="return form_request(this, 'PUT', true);">
      <label for="filename_new">Filename</label>
      <input type="text" name="filename" id="filename_new" value="" />
      <br/>
      <label for="min_size_new">Min Size</label>
      <input type="text" name="min_size" id="min_size_new" value="0" />
      <br/>
      <label for="max_size_new">Max Size</label>
      <input type="text" name="max_size" id="max_size_new"
             class="form_optional" placeholder="system max" value="" />
      <br/>
      <label for="min_lines_new">Min Lines</label>
      <input type="text" name="min_lines" id="min_lines_new" value="0" />
      <br/>
      <label for="max_lines_new">Max Lines</label>
      <input type="text" name="max_lines" id="max_lines_new"
             class="form_optional" placeholder="system max" value="" />
      <input type="hidden" name="project_id" value="${project.id}" />
      <br/>
      <input type="submit" name="submit" value="add" />
    </form>
  </div>
  <div tal:repeat="fv sorted(project.file_verifiers)" id="file_verifier_${repeat.fv.index}"
       class="dialog" title="Update Expected File ${repeat.fv.number}">
    <fieldset>
      <legend>Expected File ${repeat.fv.number}</legend>
      <form name="file_verifier" onsubmit="return form_request(this, 'POST', true);"
            action="${_R('file_verifier_item', file_verifier_id=fv.id)}">
        <label for="filename_${repeat.fv.index}">Filename</label>
        <input type="text" name="filename" id="filename_${repeat.fv.index}"
               value="${fv.filename}" />
        <br/>
        <label for="min_size_${repeat.fv.index}">Min Size</label>
        <input type="text" name="min_size" id="min_size_${repeat.fv.index}"
               value="${fv.min_size}" />
        <br/>
        <label for="max_size_${repeat.fv.index}">Max Size</label>
        <input type="text" name="max_size" id="max_size_${repeat.fv.index}"
               class="form_optional" placeholder="system max"
               value="${fv.max_size}" />
        <br/>
        <label for="min_lines_${repeat.fv.index}">Min Lines</label>
        <input type="text" name="min_lines" id="min_lines_${repeat.fv.index}"
               value="${fv.min_lines}" />
        <br/>
        <label for="max_lines_${repeat.fv.index}">Max Lines</label>
        <input type="text" name="max_lines" id="max_lines_${repeat.fv.index}"
               class="form_optional" placeholder="system max"
               value="${fv.max_lines}" />
        <br/>
        <input type="submit" name="submit" value="update" />
      </form>
    </fieldset>
  </div>

  <div tal:repeat="testable project.testables">
    <div tal:repeat="tc sorted(testable.test_cases)" class="dialog"
         id="testable_${repeat.testable.index}_tc_${repeat.tc.index}"
         title="Update test case ${repeat.tc.number}">

      <form name="test_case"
            action="${_R('test_case_item', test_case_id=tc.id)}"
            onsubmit="return form_request(this, 'POST', true);">
        <label for="testable_${repeat.testable.index}_tc_name_${repeat.tc.index}">Test Name</label>
        <input type="text" name="name" id="testable_${repeat.testable.index}_tc_name_${repeat.tc.index}" value="${tc.name}" />
        <br/>
        <label for="testable_${repeat.testable.index}_tc_args_${repeat.tc.index}">Execution line</label>
        <input type="text" name="args" id="testable_${repeat.testable.index}_tc_args_${repeat.tc.index}"
         value="${tc.args}" />
        <br/>
        <label for="testable_${repeat.testable.index}_tc_points_${repeat.tc.index}">Points</label>
        <input type="text" name="points" id="testable_${repeat.testable.index}_tc_points_${repeat.tc.index}"
               value="${tc.points}" />
        <br/>
        <div tal:condition="tc.stdin_id">
          <a href="${_R('file_item', sha1sum=tc.stdin.sha1)}">Existing standard input file</a>
        </div>
        <label for="testable_${repeat.testable.index}_tc_input_${repeat.tc.index}">Select a new standard input file: </label>
        <input name="stdin_id" id="testable_${repeat.testable.index}_tc_input_${repeat.tc.index}" type="file" />
        <br/>
        <input type="hidden" name="stdin_id" value="${tc.stdin_id}" />
        <div tal:condition="tc.expected_id">
          <a href="${_R('file_item', sha1sum=tc.expected.sha1)}">Existing expected output file</a>
        </div>
        <label for="testable_${repeat.testable.index}_tc_expected_${repeat.tc.index}">Select a new expected output file: </label>
        <input name="expected_id" id="testable_${repeat.testable.index}_tc_expected_${repeat.tc.index}" type="file" />
        <input type="hidden" name="expected_id" value="${tc.expected_id}" />
        <br/>
        <input type="submit" name="submit" value="update" />
      </form>
    </div>
    <div id="testable_${repeat.testable.index}_tc_new" class="dialog"
         title="Add new test case" style="background: #ccf">
      <form name="test_case" action="${_R('test_case')}"
            onsubmit="return form_request(this, 'PUT', true);">
        <label for="testable_${repeat.testable.index}_tc_name_new">Test Name</label>
        <input type="text" name="name" id="testable_${repeat.testable.index}_tc_name_new" />
        <br/>
        <label for="testable_${repeat.testable.index}_tc_args_new">Execution line</label>
        <input type="text" name="args" id="testable_${repeat.testable.index}_tc_args_new" value="a.out" />
        <br/>
        <label for="testable_${repeat.testable.index}_tc_points_new">Points</label>
        <input type="text" name="points" id="testable_${repeat.testable.index}_tc_points_new" value="1" />
        <br/>
        <label for="testable_${repeat.testable.index}_tc_input_new">Select a standard input file: </label>
        <input name="stdin_id" id="testable_${repeat.testable.index}_tc_input_new" type="file" />
        <br/>
        <input type="hidden" name="stdin_id" value="" />
        <label for="testable_${repeat.testable.index}_tc_expected_new">Select a expected output file: </label>
        <input name="expected_id" id="testable_${repeat.testable.index}_tc_expected_new" type="file" />
        <input type="hidden" name="expected_id" value="" />
        <input type="hidden" name="testable_id" value="${testable.id}" />
        <br/>
        <input type="submit" name="submit" value="add" />
      </form>
    </div>
  </div>


</div>
</div>
